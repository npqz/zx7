<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vespura vMenu</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: Arial, sans-serif;
      color: white;
    }

    #menu {
      position: absolute;
      top: 20%;
      left: 50px;
      width: 320px;
      background: rgba(0,0,0,0.85);
      border: 2px solid #3498db;
      border-radius: 4px;
      padding: 8px;
      display: none;
    }

    #menu h1 {
      margin: 0;
      padding: 6px;
      background: #3498db;
      font-size: 18px;
      border-radius: 2px;
      text-align: center;
    }

    #menu h2 {
      margin: 4px 0;
      font-size: 13px;
      color: #aaa;
      text-align: center;
    }

    .item {
      padding: 10px;
      margin: 2px 0;
      background: rgba(255,255,255,0.05);
      cursor: pointer;
      border-radius: 3px;
    }

    .item:hover, .item.active {
      background: #3498db;
    }

    .toggleOn { color: #2ecc71; float: right; }
    .toggleOff { color: #e74c3c; float: right; }
  </style>
</head>
<body>
  <div id="menu">
    <h1 id="menuTitle">Menu</h1>
    <h2 id="menuSubtitle"></h2>
    <div id="menuItems"></div>
  </div>

  <script>
    const menuEl = document.getElementById("menu");
    const titleEl = document.getElementById("menuTitle");
    const subtitleEl = document.getElementById("menuSubtitle");
    const itemsEl = document.getElementById("menuItems");
    let selectedIndex = 0;

    function renderMenu(data) {
      if (!data) return;

      titleEl.textContent = data.title || "Menu";
      subtitleEl.textContent = data.subtitle || "";

      itemsEl.innerHTML = "";
      (data.items || []).forEach((item, i) => {
        const div = document.createElement("div");
        div.className = "item" + (i === selectedIndex ? " active" : "");
        div.textContent = item.name;

        // show toggle state if exists
        if (item.toggle) {
          const span = document.createElement("span");
          span.className = item.state ? "toggleOn" : "toggleOff";
          span.textContent = item.state ? "ON" : "OFF";
          div.appendChild(span);
        }

        itemsEl.appendChild(div);
      });

      menuEl.style.display = "block";
    }

    function updateSelection() {
      [...itemsEl.children].forEach((el, i) => {
        el.classList.toggle("active", i === selectedIndex);
      });
    }

    // Messages from Lua
    window.addEventListener("message", (event) => {
      const data = event.data;
      if (data.type === "showMenu") {
        renderMenu(data.menu);
      } else if (data.type === "hideMenu") {
        menuEl.style.display = "none";
      }
    });

    // Keyboard nav (arrow keys + enter + backspace)
    document.addEventListener("keydown", (e) => {
      const children = [...itemsEl.children];
      if (!children.length) return;

      if (e.key === "ArrowDown") {
        selectedIndex = (selectedIndex + 1) % children.length;
        updateSelection();
      } else if (e.key === "ArrowUp") {
        selectedIndex = (selectedIndex - 1 + children.length) % children.length;
        updateSelection();
      } else if (e.key === "Enter") {
        const item = (event.data && event.data.items) ? event.data.items[selectedIndex] : null;
        fetch(`https://${GetParentResourceName()}/menuSelect`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json; charset=UTF-8' },
          body: JSON.stringify({ index: selectedIndex })
        });
      } else if (e.key === "Backspace") {
        fetch(`https://${GetParentResourceName()}/menuBack`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json; charset=UTF-8' }
        });
      }
    });
  </script>
</body>
</html>
